<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apostille Verification System</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
</head>
<body>
<header class="header">
  <div class="header-container"><div class="header-text"><h1>E-APOSTILLE GLOBAL</h1><p style="margin: 0; font-size: 11px; color: #666; font-weight: bold;">VERIFICATION SYSTEM</p></div></div>
</header>

<main class="content">
  <form class="verification-form" id="searchForm">
    <div style="text-align:center; margin-bottom:15px;">
        <h2 style="font-size: 18px; color: #0b3d91;">Verify Document</h2>
        <p style="font-size: 13px; color: #666;">Enter details to verify authenticity</p>
    </div>

    <label>Apostille Number</label>
    <input type="text" id="apostille-input" placeholder="APO-XXXX-XXXX" required>
    <label>Date of Issue</label>
    <input type="date" id="date-input" required>
    <label>Referral Code (Optional)</label>
    <input type="text" id="referral-input" placeholder="Code">

    <button type="submit" class="btn btn-main">Verify Document</button>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="button" id="scan-qr-btn" class="btn btn-secondary" style="flex: 1;">üì∑ Scan QR-code</button>
        <a href="samples.html" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; padding-top: 10px;">Samples</a>
    </div>
    
    <a href="index.html" class="btn btn-secondary" style="margin-top: 10px; text-align: center; width: 100%; text-decoration: none; padding-top: 10px;">‚Üê Back to Home</a>
  </form>
</main>

<div id="qr-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:9999; flex-direction:column; justify-content:center; align-items:center;">
    <div style="position:absolute; top:20px; right:20px; z-index:10000;">
        <button id="close-qr" style="background:white; border:none; border-radius:50%; width:40px; height:40px; font-size:24px;">&times;</button>
    </div>
    <h3 style="color:white; margin-bottom:20px;">Scan QR Code</h3>
    <div style="position: relative; width: 100%; max-width: 500px; aspect-ratio: 1/1; overflow: hidden; border-radius: 12px; border: 2px solid white;">
        <video id="qr-video" style="width: 100%; height: 100%; object-fit: cover;"></video>
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.5); pointer-events: none;"></div>
    </div>
    <p id="qr-status" style="color: #ccc; margin-top: 20px; text-align: center;"></p>
</div>

<script>
    // –ü–æ–∏—Å–∫ –≤–µ–¥–µ—Ç –Ω–∞ result.html
    document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const apostille = document.getElementById("apostille-input").value.trim();
        const date = document.getElementById("date-input").value;
        const referral = document.getElementById("referral-input").value.trim();
        
        if(apostille && date) {
            let url = `result.html?apostille=${encodeURIComponent(apostille)}&date=${encodeURIComponent(date)}`;
            if(referral) url += `&ref=${encodeURIComponent(referral)}`;
            window.location.href = url;
        }
    });

    const scanBtn = document.getElementById("scan-qr-btn");
    const modal = document.getElementById("qr-modal");
    const closeBtn = document.getElementById("close-qr");
    const videoElem = document.getElementById("qr-video");
    const statusText = document.getElementById("qr-status");
    let scanner = null;

    QrScanner.WORKER_PATH = 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js';

    scanBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        statusText.innerText = "Starting camera...";
        startScanner();
    });

    closeBtn.addEventListener("click", stopScanner);

    async function startScanner() {
        if (location.protocol !== "https:" && location.hostname !== "localhost") {
            statusText.style.color = "red";
            statusText.innerText = "Error: Camera needs HTTPS!";
            return;
        }
        try {
            scanner = new QrScanner(videoElem, result => {
                const text = result.data || result; 
                statusText.style.color = "#4caf50";
                statusText.innerText = "Found! Redirecting...";
                stopScanner();
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ä–æ–≥–æ QR –∫–æ–¥–∞ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É result.html
                if (text.includes("apostille=") && text.includes("date=")) {
                    let redirectUrl = text;
                    if(redirectUrl.includes("index.html")) {
                        redirectUrl = redirectUrl.replace("index.html", "result.html");
                    }
                    window.location.href = redirectUrl;
                }
                else {
                    alert("QR code scanned: " + text + "\nNot an apostille document.");
                }
            }, { highlightScanRegion: true, highlightCodeOutline: true });
            await scanner.start();
            statusText.innerText = "Point camera at QR code";
        } catch (e) {
            statusText.style.color = "red";
            statusText.innerText = "Camera Error: " + e;
        }
    }

    function stopScanner() {
        if (scanner) { scanner.stop(); scanner.destroy(); scanner = null; }
        modal.style.display = "none";
    }
</script>
</body>
</html>
