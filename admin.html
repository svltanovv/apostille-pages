<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apostille Admin Panel</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .qr-container { display: flex; justify-content: center; margin: 12px 0; padding: 10px; background: #f5f6fa; border-radius: 6px; }
    .qr-container canvas { max-width: 100%; height: auto; }
    .file-card { background-color: #ffffff; padding: 14px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); font-size: 13px; line-height: 1.6; }
    .file-card strong { display: block; margin-bottom: 4px; color: #212529; }
    .file-card-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .file-card-actions a, .file-card-actions button { flex: 1; min-width: 80px; padding: 6px 8px; font-size: 12px; text-align: center; border-radius: 4px; border: none; cursor: pointer; text-decoration: none; display: inline-block; transition: all 0.15s ease; }
    .btn-open-pdf { background-color: #0b3d91; color: white; }
    .btn-download-qr { background-color: #e9ecef; color: #212529; border: 1px solid #ced4da; }
    .btn-delete { background-color: #dc3545; color: white; }
    .search-box { margin-bottom: 16px; }
    .search-box input { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; }
    .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; margin-top: 12px; }
    .no-documents { text-align: center; padding: 20px; color: #6c757d; font-size: 14px; }
    .status-message { padding: 10px 12px; border-radius: 4px; margin-bottom: 12px; font-size: 13px; display: none; }
    .status-message.success { display: block; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-message.error { display: block; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-container"><div class="header-text"><h1>Apostille Admin Panel</h1></div></div>
  </header>

  <main class="content" style="max-width: 800px">
    <div id="login-block">
      <h2 style="margin-bottom: 15px; color: #2f5233">Admin Login</h2>
      
      <div id="login-status" class="status-message" style="margin-bottom: 15px;"></div>

      <label>Email</label>
      <input type="email" id="admin-email" placeholder="admin@example.com" />
      <label>Password</label>
      <input type="password" id="admin-password" placeholder="Enter password" />
      <button class="btn btn-main" id="login-btn">Login</button>
    </div>

    <div id="admin-block" style="display: none">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #2f5233; margin: 0">Upload Document</h2>
        <button class="btn btn-secondary" id="logout-btn">Logout</button>
      </div>

      <div id="status-message" class="status-message"></div>

      <label>Apostille Number</label>
      <input type="text" id="apostille-number" placeholder="e.g., APO-2026-001" />

      <label>Date of Issue</label>
      <input type="date" id="issue-date" />

      <label>Referral Code (Optional)</label>
      <input type="text" id="referral-code" placeholder="REF-123" />

      <label>PDF File</label>
      <input type="file" id="pdf-file" accept="application/pdf" />

      <button class="btn btn-main" id="upload-btn" style="margin-top: 10px; width: 100%">Upload PDF</button>

      <h3 style="margin: 28px 0 12px; color: #2f5233">Uploaded Documents</h3>
      <div class="search-box"><input type="text" id="search-input" placeholder="Search..." /></div>
      <div id="file-list" class="file-grid"></div>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://tfdrjiztsbuusngfdmye.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmZHJqaXp0c2J1dXNuZ2ZkbXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MDMwMDMsImV4cCI6MjA4NDM3OTAwM30.jFFfWfU1vFrE_0XvnVm0wL1cW0O6QHtwAUbUv9mGMC4";

    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let allDocuments = [];

    // --- Безопасная проверка сессии (Исправлено) ---
    async function checkSession() {
      try {
        const { data, error } = await db.auth.getSession();
        
        if (error) {
           console.error("Session Error:", error);
           return;
        }

        const session = data?.session; // Безопасное чтение

        if (session) {
          document.getElementById("login-block").style.display = "none";
          document.getElementById("admin-block").style.display = "block";
          loadFiles();
        } else {
          document.getElementById("login-block").style.display = "block";
          document.getElementById("admin-block").style.display = "none";
        }
      } catch (err) {
        console.error("CheckSession Crash:", err);
      }
    }
    
    // Запускаем проверку при загрузке
    checkSession();

    // --- Логика Входа ---
    document.getElementById("login-btn").addEventListener("click", async () => {
      const email = document.getElementById("admin-email").value.trim();
      const password = document.getElementById("admin-password").value.trim();
      const statusEl = document.getElementById("login-status");

      if (!email || !password) {
        statusEl.textContent = "Please enter email and password";
        statusEl.className = "status-message error";
        return;
      }

      statusEl.textContent = "Logging in...";
      statusEl.className = "status-message"; // Сброс стиля
      statusEl.style.display = "block";

      const { data, error } = await db.auth.signInWithPassword({ email, password });

      if (error) {
        console.error("Login fail:", error);
        statusEl.textContent = "Error: " + error.message;
        statusEl.className = "status-message error";
        return;
      }

      statusEl.textContent = "Success!";
      statusEl.className = "status-message success";
      checkSession();
    });

    document.getElementById("logout-btn").addEventListener("click", async () => {
      await db.auth.signOut();
      checkSession();
    });

    // --- Загрузка документа ---
    document.getElementById("upload-btn").addEventListener("click", async () => {
      const btn = document.getElementById("upload-btn");
      const apostille = document.getElementById("apostille-number").value.trim();
      const issueDate = document.getElementById("issue-date").value.trim();
      const referralCode = document.getElementById("referral-code").value.trim();
      const file = document.getElementById("pdf-file").files[0];

      if (!apostille || !issueDate || !file) return showStatus("Fill required fields", "error");

      btn.disabled = true; btn.textContent = "Uploading...";
      const filePath = `${Date.now()}_${file.name}`;

      const { error: uploadError } = await db.storage.from("apostilles").upload(filePath, file);
      if (uploadError) { btn.disabled = false; return showStatus(uploadError.message, "error"); }

      const { error: dbError } = await db.from("apostilles").insert({
        apostille_number: apostille, issue_date: issueDate, referral_code: referralCode, file_path: filePath
      });

      if (dbError) { btn.disabled = false; return showStatus(dbError.message, "error"); }

      showStatus("Success", "success");
      document.getElementById("apostille-number").value = "";
      document.getElementById("pdf-file").value = "";
      btn.disabled = false; btn.textContent = "Upload PDF";
      loadFiles();
    });

    async function loadFiles() {
      const list = document.getElementById("file-list");
      list.innerHTML = "Loading...";
      const { data, error } = await db.from("apostilles").select("*").order("created_at", { ascending: false });
      
      if (error) return list.innerHTML = "Error loading";
      if (!data || !data.length) return list.innerHTML = "<div class='no-documents'>No documents</div>";

      allDocuments = data;
      renderFiles(data);
    }

    function renderFiles(files) {
      const list = document.getElementById("file-list");
      list.innerHTML = "";
      
      files.forEach((row) => {
        const { data: publicData } = db.storage.from("apostilles").getPublicUrl(row.file_path);
        
        // === УНИВЕРСАЛЬНАЯ ССЫЛКА (РАБОТАЕТ ВЕЗДЕ) ===
        const qrUrl = new URL("index.html", window.location.href);
        qrUrl.searchParams.set("apostille", row.apostille_number);
        qrUrl.searchParams.set("date", row.issue_date);
        const qrLink = qrUrl.toString();
        // =============================================
        
        const card = document.createElement("div");
        card.className = "file-card";
        const qrId = `qr-${row.id}`;

        card.innerHTML = `
          <strong>${row.apostille_number}</strong> (${row.issue_date})<br>
          ${row.referral_code ? `<small>Ref: ${row.referral_code}</small>` : ''}
          <div id="${qrId}" class="qr-container"></div>
          <div class="file-card-actions">
            <a href="${publicData.publicUrl}" target="_blank" class="btn-open-pdf">PDF</a>
            <button class="btn-delete" onclick="deleteDoc(${row.id}, '${row.file_path}')">Delete</button>
          </div>
        `;
        list.appendChild(card);

        setTimeout(() => {
          new QRCode(document.getElementById(qrId), { text: qrLink, width: 128, height: 128 });
        }, 100);
      });
    }

    document.getElementById("search-input").addEventListener("input", (e) => {
      const query = e.target.value.toLowerCase();
      renderFiles(allDocuments.filter(d => d.apostille_number.toLowerCase().includes(query)));
    });

    window.deleteDoc = async (id, path) => {
      if (!confirm("Delete?")) return;
      await db.storage.from("apostilles").remove([path]);
      await db.from("apostilles").delete().eq("id", id);
      loadFiles();
    };

    function showStatus(msg, type) {
      const el = document.getElementById("status-message");
      el.textContent = msg; el.className = `status-message ${type}`;
      el.style.display = 'block'; // Принудительно показываем
      setTimeout(() => el.style.display = 'none', 4000);
    }
  </script>
</body>
</html>
