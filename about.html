<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apostille Verification System</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
</head>
<body>
<header class="header">
  <div class="header-container">
    <div class="header-text">
      <h1>Legalization / Apostille Verification System</h1>
    </div>
  </div>
</header>

<main class="content">
  <form class="verification-form" id="searchForm">
    <div style="text-align:center; margin-bottom:15px;">
        <h2 style="font-size: 18px; color: #0b3d91; margin: 0;">Verify Document</h2>
        <p style="font-size: 13px; color: #666; margin: 8px 0 0;">Enter details to verify authenticity</p>
    </div>

    <label for="apostille-input">Apostille Number</label>
    <input type="text" id="apostille-input" placeholder="APO-XXXX-XXXX" required>

    <label for="date-input">Date of Issue</label>
    <input type="date" id="date-input" required>

    <label for="referral-input">Referral Code (Optional)</label>
    <input type="text" id="referral-input" placeholder="Code">

    <button type="submit" class="btn btn-main">Verify Document</button>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="button" id="scan-qr-btn" class="btn btn-secondary" style="flex: 1;">
            ðŸ“· Scan QR-code
        </button>
        <a href="samples.html" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; padding-top: 10px;">
            View Samples
        </a>
    </div>

    <a href="dashboard.html" class="btn btn-secondary" style="margin-top: 10px; text-align: center; width: 100%; text-decoration: none; padding-top: 10px;">
        Upload your Document (Login)
    </a>
  </form>
</main>

<div id="qr-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%; position:relative; text-align: center;">
    
    <button id="close-qr" style="position:absolute; right:10px; top:5px; border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
    
    <h3 style="margin-bottom: 15px;">Scan QR Code</h3>
    
    <div id="qr-reader" style="width:100%;"></div>
    
    <p id="qr-status" style="font-size:13px; color:#d9534f; margin-top:10px; font-weight: bold; min-height: 20px;"></p>
    
    <p style="font-size:12px; color:#666; margin-top:10px;">
        Point your camera at the QR code.
    </p>
  </div>
</div>

<script>
    // --- Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¿Ð¾Ð¸ÑÐºÐ° (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ) ---
    document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const apostille = document.getElementById("apostille-input").value.trim();
        const date = document.getElementById("date-input").value;
        const referral = document.getElementById("referral-input").value.trim();
        
        if(apostille && date) {
            let url = `index.html?apostille=${encodeURIComponent(apostille)}&date=${encodeURIComponent(date)}`;
            if(referral) url += `&ref=${encodeURIComponent(referral)}`;
            window.location.href = url;
        }
    });

    // --- Ð£ÐŸÐ ÐžÐ©Ð•ÐÐÐ«Ð™ Ð¡ÐšÐÐÐ•Ð  ---
    const scanBtn = document.getElementById("scan-qr-btn");
    const modal = document.getElementById("qr-modal");
    const closeBtn = document.getElementById("close-qr");
    const statusText = document.getElementById("qr-status");
    let html5QrcodeScanner = null;

    scanBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        statusText.style.color = "blue";
        statusText.innerText = "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹...";
        startScanner();
    });

    closeBtn.addEventListener("click", stopScanner);
    modal.addEventListener("click", (e) => { if (e.target === modal) stopScanner(); });

    function startScanner() {
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° 1: Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°
        if (typeof Html5Qrcode === "undefined") {
            statusText.innerText = "ÐžÐ¨Ð˜Ð‘ÐšÐ: Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ.";
            return;
        }

        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° 2: HTTPS
        if (location.protocol !== "https:" && location.hostname !== "localhost") {
            statusText.innerText = "ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÑƒÐ¶ÐµÐ½ HTTPS. Ð’Ñ‹ Ð·Ð°ÑˆÐ»Ð¸ Ñ‡ÐµÑ€ÐµÐ· http:// ?";
            return;
        }

        // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾
        if (html5QrcodeScanner) { try { html5QrcodeScanner.clear(); } catch(e){} }

        html5QrcodeScanner = new Html5Qrcode("qr-reader");

        // Ð—ÐÐŸÐ£Ð¡Ðš Ð‘Ð•Ð— QRBOX (Ð¡Ð°Ð¼Ñ‹Ð¹ Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°)
        // ÐœÑ‹ ÑƒÐ±Ñ€Ð°Ð»Ð¸ qrbox Ð¸ aspectRatio, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÐºÐ°Ð¼ÐµÑ€Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ð»Ð°ÑÑŒ
        html5QrcodeScanner.start(
            { facingMode: "environment" }, 
            { fps: 10 }, // ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
            (decodedText) => {
                // Ð£ÑÐ¿ÐµÑ…
                statusText.style.color = "green";
                statusText.innerText = "ÐÐ°Ð¹Ð´ÐµÐ½Ð¾! " + decodedText;
                stopScanner();
                if (decodedText.includes("apostille=")) {
                    window.location.href = decodedText;
                } else {
                    alert("QR ÐºÐ¾Ð´ ÑÑ‡Ð¸Ñ‚Ð°Ð½: " + decodedText);
                }
            },
            (error) => {
                // ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼
            }
        ).catch(err => {
            // Ð’ÐžÐ¢ Ð­Ð¢ÐžÐ¢ Ð¢Ð•ÐšÐ¡Ð¢ Ð’ÐÐ–Ð•Ð
            console.error("Critical Error:", err);
            statusText.style.color = "red";
            statusText.innerText = "ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: " + err;
        });
    }

    function stopScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                modal.style.display = "none";
            }).catch(() => { modal.style.display = "none"; });
        } else {
            modal.style.display = "none";
        }
    }
</script>
