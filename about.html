<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apostille Verification System</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
</head>
<body>
<header class="header">
  <div class="header-container">
    <div class="header-text">
      <h1>Legalization / Apostille Verification System</h1>
    </div>
  </div>
</header>

<main class="content">
  <form class="verification-form" id="searchForm">
    <div style="text-align:center; margin-bottom:15px;">
        <h2 style="font-size: 18px; color: #0b3d91; margin: 0;">Verify Document</h2>
        <p style="font-size: 13px; color: #666; margin: 8px 0 0;">Enter details to verify authenticity</p>
    </div>

    <label for="apostille-input">Apostille Number</label>
    <input type="text" id="apostille-input" placeholder="APO-XXXX-XXXX" required>

    <label for="date-input">Date of Issue</label>
    <input type="date" id="date-input" required>

    <label for="referral-input">Referral Code (Optional)</label>
    <input type="text" id="referral-input" placeholder="Code">

    <button type="submit" class="btn btn-main">Verify Document</button>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="button" id="scan-qr-btn" class="btn btn-secondary" style="flex: 1;">
            ðŸ“· Scan QR-code
        </button>
        <a href="samples.html" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; padding-top: 10px;">
            View Samples
        </a>
    </div>

    <a href="dashboard.html" class="btn btn-secondary" style="margin-top: 10px; text-align: center; width: 100%; text-decoration: none; padding-top: 10px;">
        Upload your Document (Login)
    </a>
  </form>
</main>

<div id="qr-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%; position:relative; text-align: center;">
    
    <button id="close-qr" style="position:absolute; right:10px; top:5px; border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
    
    <h3 style="margin-bottom: 15px;">Scan QR Code</h3>
    
    <div id="qr-reader" style="width:100%;"></div>
    
    <p id="qr-status" style="font-size:13px; color:#d9534f; margin-top:10px; font-weight: bold; min-height: 20px;"></p>
    
    <p style="font-size:12px; color:#666; margin-top:10px;">
        Point your camera at the QR code.
    </p>
  </div>
</div>

<script>
    // === Ð›ÐžÐ“Ð˜ÐšÐ Ð¤ÐžÐ ÐœÐ« ÐŸÐžÐ˜Ð¡ÐšÐ ===
    document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const apostille = document.getElementById("apostille-input").value.trim();
        const date = document.getElementById("date-input").value;
        const referral = document.getElementById("referral-input").value.trim();
        
        if(apostille && date) {
            let url = `index.html?apostille=${encodeURIComponent(apostille)}&date=${encodeURIComponent(date)}`;
            if(referral) url += `&ref=${encodeURIComponent(referral)}`;
            window.location.href = url;
        }
    });

    // === Ð›ÐžÐ“Ð˜ÐšÐ Ð¡ÐšÐÐÐ•Ð Ð QR ===
    const scanBtn = document.getElementById("scan-qr-btn");
    const modal = document.getElementById("qr-modal");
    const closeBtn = document.getElementById("close-qr");
    const statusText = document.getElementById("qr-status");
    let html5QrcodeScanner = null;

    scanBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        statusText.style.color = "#333";
        statusText.textContent = "Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¼ÐµÑ€Ñ‹...";
        startScanner();
    });

    closeBtn.addEventListener("click", stopScanner);
    modal.addEventListener("click", (e) => {
        if (e.target === modal) stopScanner();
    });

    function startScanner() {
        if (typeof Html5Qrcode === "undefined") {
            statusText.textContent = "ÐžÑˆÐ¸Ð±ÐºÐ°: Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° ÑÐºÐ°Ð½ÐµÑ€Ð° Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»Ð°ÑÑŒ.";
            return;
        }

        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° HTTPS
        if (location.protocol !== "https:" && location.hostname !== "localhost" && location.hostname !== "127.0.0.1") {
            statusText.textContent = "ÐžÑˆÐ¸Ð±ÐºÐ°: ÐšÐ°Ð¼ÐµÑ€Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ HTTPS (GitHub Pages).";
            return;
        }

        if (html5QrcodeScanner) {
            // Ð•ÑÐ»Ð¸ ÑÐºÐ°Ð½ÐµÑ€ ÑƒÐ¶Ðµ Ð±Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½, Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ð¼ ÐµÐ³Ð¾
            html5QrcodeScanner.clear().catch(err => console.error("Clear error", err));
        }

        html5QrcodeScanner = new Html5Qrcode("qr-reader");

        // ÐÐ´Ð°Ð¿Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð° ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
        const qrBoxSize = Math.min(250, window.innerWidth * 0.7);

        const config = { 
            fps: 10, 
            qrbox: { width: qrBoxSize, height: qrBoxSize },
            aspectRatio: 1.0 
        };

        html5QrcodeScanner.start(
            { facingMode: "environment" }, 
            config,
            onScanSuccess,
            (errorMessage) => {
                // ÐžÑˆÐ¸Ð±ÐºÐ¸ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼, ÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾
            }
        ).catch(err => {
            console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°:", err);
            statusText.style.color = "red";
            statusText.textContent = "ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÐºÐ°Ð¼ÐµÑ€Ðµ: " + err;
        });
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Scan result: ${decodedText}`);
        statusText.style.color = "green";
        statusText.textContent = "ÐšÐ¾Ð´ Ð½Ð°Ð¹Ð´ÐµÐ½! ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°...";
        
        stopScanner();

        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð»Ð¸ QR ÑÑÑ‹Ð»ÐºÑƒ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
        if (decodedText.includes("apostille=") && decodedText.includes("date=")) {
            // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¿Ð¾Ð»Ð½Ð°Ñ ÑÑÑ‹Ð»ÐºÐ° - Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼
            if (decodedText.startsWith("http")) {
                 window.location.href = decodedText;
            } else {
                 // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ‚ÐµÐºÑÑ‚, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ ÐµÐ³Ð¾ ÑÑÑ‹Ð»ÐºÐ¾Ð¹ (Ð½Ð° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹)
                 window.location.href = decodedText;
            }
        } else {
            alert("Ð­Ñ‚Ð¾Ñ‚ QR-ÐºÐ¾Ð´ Ð½Ðµ Ð¾Ñ‚ Ð½Ð°ÑˆÐµÐ³Ð¾ ÑÐ°Ð¹Ñ‚Ð°.\nÐ¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ: " + decodedText);
        }
    }

    function stopScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                modal.style.display = "none";
                statusText.textContent = "";
            }).catch(err => {
                console.error("Stop error", err);
                modal.style.display = "none";
            });
        } else {
            modal.style.display = "none";
        }
    }
</script>
</body>
</html>
