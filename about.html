<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apostille Verification System</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
</head>
<body>
<header class="header">
  <div class="header-container">
    <div class="header-text">
      <h1>Legalization / Apostille Verification System</h1>
    </div>
  </div>
</header>

<main class="content">
  <form class="verification-form" id="searchForm">
    <div style="text-align:center; margin-bottom:15px;">
        <h2 style="font-size: 18px; color: #0b3d91; margin: 0;">Verify Document</h2>
        <p style="font-size: 13px; color: #666; margin: 8px 0 0;">Enter details to verify authenticity</p>
    </div>

    <label for="apostille-input">Apostille Number</label>
    <input type="text" id="apostille-input" placeholder="APO-XXXX-XXXX" required>

    <label for="date-input">Date of Issue</label>
    <input type="date" id="date-input" required>

    <label for="referral-input">Referral Code (Optional)</label>
    <input type="text" id="referral-input" placeholder="Code">

    <button type="submit" class="btn btn-main">Verify Document</button>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="button" id="scan-qr-btn" class="btn btn-secondary" style="flex: 1;">
            ðŸ“· Scan QR-code
        </button>
        <a href="samples.html" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; padding-top: 10px;">
            View Samples
        </a>
    </div>

    <a href="dashboard.html" class="btn btn-secondary" style="margin-top: 10px; text-align: center; width: 100%; text-decoration: none; padding-top: 10px;">
        Upload your Document (Login)
    </a>
  </form>
</main>

<div id="qr-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%; position:relative; text-align: center;">
    
    <button id="close-qr" style="position:absolute; right:10px; top:5px; border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
    
    <h3 style="margin-bottom: 15px;">Scan QR Code</h3>
    
    <div id="qr-reader" style="width:100%; min-height: 250px; background: #f0f0f0;"></div>
    
    <p id="qr-status" style="font-size:14px; color:#d9534f; margin-top:10px; font-weight: bold;"></p>
    
    <p style="font-size:12px; color:#666; margin-top:10px;">
        Point your camera at the QR code on the document.
    </p>
  </div>
</div>

<script>
    // === Ð›ÐžÐ“Ð˜ÐšÐ Ð¤ÐžÐ ÐœÐ« ÐŸÐžÐ˜Ð¡ÐšÐ ===
    document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const apostille = document.getElementById("apostille-input").value.trim();
        const date = document.getElementById("date-input").value;
        const referral = document.getElementById("referral-input").value.trim();
        
        if(apostille && date) {
            let url = `index.html?apostille=${encodeURIComponent(apostille)}&date=${encodeURIComponent(date)}`;
            if(referral) url += `&ref=${encodeURIComponent(referral)}`;
            window.location.href = url;
        }
    });

    // === Ð›ÐžÐ“Ð˜ÐšÐ Ð¡ÐšÐÐÐ•Ð Ð QR ===
    const scanBtn = document.getElementById("scan-qr-btn");
    const modal = document.getElementById("qr-modal");
    const closeBtn = document.getElementById("close-qr");
    const statusText = document.getElementById("qr-status");
    let html5QrcodeScanner = null;

    scanBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        statusText.textContent = "Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹...";
        startScanner();
    });

    closeBtn.addEventListener("click", stopScanner);
    
    // Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸ ÐºÐ»Ð¸ÐºÐµ Ð½Ð° Ñ‡ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ð½
    modal.addEventListener("click", (e) => {
        if (e.target === modal) stopScanner();
    });

    function startScanner() {
        // 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°: Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»Ð°ÑÑŒ Ð»Ð¸ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°?
        if (typeof Html5Qrcode === "undefined") {
            statusText.textContent = "ÐžÑˆÐ¸Ð±ÐºÐ°: Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° ÑÐºÐ°Ð½ÐµÑ€Ð° Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»Ð°ÑÑŒ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚.";
            return;
        }

        // 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° HTTPS (ÐºÐ°Ð¼ÐµÑ€Ð° Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð±ÐµÐ· Ð½ÐµÐ³Ð¾, ÐºÑ€Ð¾Ð¼Ðµ localhost)
        if (location.protocol !== "https:" && location.hostname !== "localhost" && location.hostname !== "127.0.0.1") {
            statusText.textContent = "ÐžÑˆÐ¸Ð±ÐºÐ°: ÐšÐ°Ð¼ÐµÑ€Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ HTTPS! Ð—Ð°Ð»ÐµÐ¹Ñ‚Ðµ ÑÐ°Ð¹Ñ‚ Ð½Ð° Vercel.";
            return;
        }

        statusText.textContent = "Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÐºÐ°Ð¼ÐµÑ€Ðµ... Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿!";

        html5QrcodeScanner = new Html5Qrcode("qr-reader");

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¼ÐµÑ€Ñ‹
        html5QrcodeScanner.start(
            { facingMode: "environment" }, // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð·Ð°Ð´Ð½ÑŽÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ
            config,
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹:", err);
            statusText.textContent = "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹: " + err;
        });
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Code matched = ${decodedText}`, decodedResult);
        statusText.style.color = "green";
        statusText.textContent = "QR-ÐºÐ¾Ð´ Ð½Ð°Ð¹Ð´ÐµÐ½! ÐŸÐµÑ€ÐµÑ…Ð¾Ð´...";
        
        stopScanner();
        
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð»Ð¸ ÐºÐ¾Ð´ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
        // ÐžÐ½ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ ÑÑÑ‹Ð»ÐºÐ¾Ð¹ (https://...) Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸
        if (decodedText.includes("apostille=") && decodedText.includes("date=")) {
            window.location.href = decodedText;
        } else {
            alert("QR-ÐºÐ¾Ð´ Ð½Ðµ Ð¾Ñ‚ ÑÑ‚Ð¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ð° (Ð½ÐµÑ‚ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð°Ð¿Ð¾ÑÑ‚Ð¸Ð»Ñ).");
        }
    }

    function onScanFailure(error) {
        // ÐžÑˆÐ¸Ð±ÐºÐ¸ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ (Ð¿Ð¾ÐºÐ° Ð¸Ñ‰ÐµÑ‚ ÐºÐ¾Ð´) â€” ÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾, Ð½Ðµ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¸Ñ…
        // console.warn(`Code scan error = ${error}`);
        // Ð•ÑÐ»Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð²Ð¸ÑÐµÐ» "Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°", Ð¼ÐµÐ½ÑÐµÐ¼ ÐµÐ³Ð¾ Ð½Ð° "Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ..."
        if (statusText.textContent.includes("Ð—Ð°Ð¿Ñ€Ð¾Ñ")) {
            statusText.style.color = "#0b3d91";
            statusText.textContent = "Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ... ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ.";
        }
    }

    function stopScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                modal.style.display = "none";
                statusText.textContent = "";
            }).catch(err => {
                console.error("Failed to stop scanner", err);
                modal.style.display = "none";
            });
        } else {
            modal.style.display = "none";
        }
    }
</script>
</body>
</html>
