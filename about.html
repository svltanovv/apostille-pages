<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apostille Verification System</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
</head>
<body>
<header class="header">
  <div class="header-container">
    <div class="header-text">
      <h1>Legalization / Apostille Verification System</h1>
    </div>
  </div>
</header>

<main class="content">
  <form class="verification-form" id="searchForm">
    <div style="text-align:center; margin-bottom:15px;">
        <h2 style="font-size: 18px; color: #0b3d91; margin: 0;">Verify Document</h2>
        <p style="font-size: 13px; color: #666; margin: 8px 0 0;">Enter details to verify authenticity</p>
    </div>

    <label for="apostille-input">Apostille Number</label>
    <input type="text" id="apostille-input" placeholder="APO-XXXX-XXXX" required>

    <label for="date-input">Date of Issue</label>
    <input type="date" id="date-input" required>

    <label for="referral-input">Referral Code (Optional)</label>
    <input type="text" id="referral-input" placeholder="Code">

    <button type="submit" class="btn btn-main">Verify Document</button>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="button" id="scan-qr-btn" class="btn btn-secondary" style="flex: 1;">
            üì∑ Scan QR-code
        </button>
        <a href="samples.html" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; padding-top: 10px;">
            View Samples
        </a>
    </div>

    <a href="dashboard.html" class="btn btn-secondary" style="margin-top: 10px; text-align: center; width: 100%; text-decoration: none; padding-top: 10px;">
        Upload your Document (Login)
    </a>
  </form>
</main>

<div id="qr-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%; position:relative; text-align: center;">
    
    <button id="close-qr" style="position:absolute; right:10px; top:5px; border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
    
    <h3 style="margin-bottom: 15px;">Scan QR Code</h3>
    
    <div id="qr-reader" style="width:100%;"></div>
    
    <p id="qr-status" style="font-size:13px; color:#d9534f; margin-top:10px; font-weight: bold; min-height: 20px;"></p>
    
    <p style="font-size:12px; color:#666; margin-top:10px;">
        Point your camera at the QR code.
    </p>
  </div>
</div>

<script>
    // === –õ–û–ì–ò–ö–ê –§–û–†–ú–´ –ü–û–ò–°–ö–ê ===
    document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const apostille = document.getElementById("apostille-input").value.trim();
        const date = document.getElementById("date-input").value;
        const referral = document.getElementById("referral-input").value.trim();
        
        if(apostille && date) {
            let url = `index.html?apostille=${encodeURIComponent(apostille)}&date=${encodeURIComponent(date)}`;
            if(referral) url += `&ref=${encodeURIComponent(referral)}`;
            window.location.href = url;
        }
    });

    // === –õ–û–ì–ò–ö–ê –°–ö–ê–ù–ï–†–ê QR (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø) ===
    const scanBtn = document.getElementById("scan-qr-btn");
    const modal = document.getElementById("qr-modal");
    const closeBtn = document.getElementById("close-qr");
    const statusText = document.getElementById("qr-status");
    let html5QrcodeScanner = null;

    scanBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        statusText.style.color = "#333";
        statusText.innerText = "–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã... –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.";
        startScanner();
    });

    closeBtn.addEventListener("click", stopScanner);
    
    // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–µ—Ä–Ω—ã–π —Ñ–æ–Ω
    modal.addEventListener("click", (e) => {
        if (e.target === modal) stopScanner();
    });

    function startScanner() {
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        if (typeof Html5Qrcode === "undefined") {
            statusText.innerText = "–û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.";
            return;
        }

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS (–ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø –¢–ï–õ–ï–§–û–ù–û–í)
        const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
        const isHttps = location.protocol === "https:";
        
        if (!isHttps && !isLocal) {
            statusText.style.color = "red";
            statusText.innerText = "–û—à–∏–±–∫–∞: –ö–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø–æ HTTPS. (GitHub Pages –¥–∞–µ—Ç HTTPS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).";
            return;
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
        if (html5QrcodeScanner) {
             try { html5QrcodeScanner.clear(); } catch(e){}
        }

        html5QrcodeScanner = new Html5Qrcode("qr-reader");

        // 3. –ê–î–ê–ü–¢–ò–í–ù–´–ô –†–ê–ó–ú–ï–† (–ß–¢–û–ë–´ –ù–ï –ë–´–õ–û –û–®–ò–ë–û–ö –ù–ê –¢–ï–õ–ï–§–û–ù–ï)
        // –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω –º–µ–Ω—å—à–µ 300px, –±–µ—Ä–µ–º 70% –æ—Ç –Ω–µ–≥–æ. –ò–Ω–∞—á–µ 250px.
        const qrBoxSize = window.innerWidth < 350 ? Math.floor(window.innerWidth * 0.7) : 250;

        const config = { 
            fps: 10, 
            qrbox: { width: qrBoxSize, height: qrBoxSize },
            aspectRatio: 1.0 
        };

        // –ó–∞–ø—É—Å–∫
        html5QrcodeScanner.start(
            { facingMode: "environment" }, // –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
            config,
            onScanSuccess,
            (errorMessage) => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–≥–¥–∞ –∏—â–µ—Ç –∫–æ–¥)
            }
        ).catch(err => {
            console.error("Camera Error:", err);
            statusText.style.color = "red";
            // –í—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω
            statusText.innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É: " + err;
        });
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Scan result: ${decodedText}`);
        statusText.style.color = "green";
        statusText.innerText = "–ö–æ–¥ –Ω–∞–π–¥–µ–Ω! –ü–µ—Ä–µ—Ö–æ–¥...";
        
        stopScanner();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—à–∞ –ª–∏ —ç—Ç–æ —Å—Å—ã–ª–∫–∞
        if (decodedText.includes("apostille=") && decodedText.includes("date=")) {
             window.location.href = decodedText;
        } else {
            alert("QR-–∫–æ–¥ —Å—á–∏—Ç–∞–Ω, –Ω–æ —ç—Ç–æ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç –∞–ø–æ—Å—Ç–∏–ª—è.\n–¢–µ–∫—Å—Ç: " + decodedText);
        }
    }

    function stopScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                modal.style.display = "none";
                statusText.innerText = "";
            }).catch(err => {
                console.error("Stop error", err);
                modal.style.display = "none";
            });
        } else {
            modal.style.display = "none";
        }
    }
</script>
