<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apostille Verification System</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
</head>
<body>
<header class="header">
  <div class="header-container">
    <div class="header-text">
      <h1>Legalization / Apostille Verification System</h1>
    </div>
  </div>
</header>

<main class="content">
  <form class="verification-form" id="searchForm">
    <div style="text-align:center; margin-bottom:15px;">
        <h2 style="font-size: 18px; color: #0b3d91; margin: 0;">Verify Document</h2>
        <p style="font-size: 13px; color: #666; margin: 8px 0 0;">Enter details to verify authenticity</p>
    </div>

    <label for="apostille-input">Apostille Number</label>
    <input type="text" id="apostille-input" placeholder="APO-XXXX-XXXX" required>

    <label for="date-input">Date of Issue</label>
    <input type="date" id="date-input" required>

    <label for="referral-input">Referral Code (Optional)</label>
    <input type="text" id="referral-input" placeholder="Code">

    <button type="submit" class="btn btn-main">Verify Document</button>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="button" id="scan-qr-btn" class="btn btn-secondary" style="flex: 1;">
            üì∑ Scan QR-code
        </button>
        <a href="samples.html" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; padding-top: 10px;">
            View Samples
        </a>
    </div>

    <a href="dashboard.html" class="btn btn-secondary" style="margin-top: 10px; text-align: center; width: 100%; text-decoration: none; padding-top: 10px;">
        Upload your Document (Login)
    </a>
  </form>
</main>

<div id="qr-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:9999; flex-direction:column; justify-content:center; align-items:center;">
    
    <div style="position:absolute; top:20px; right:20px; z-index:10000;">
        <button id="close-qr" style="background:white; border:none; border-radius:50%; width:40px; height:40px; font-size:24px; cursor:pointer;">&times;</button>
    </div>

    <h3 style="color:white; margin-bottom:20px; z-index:10000;">Scan QR Code</h3>

    <div style="position: relative; width: 100%; max-width: 500px; aspect-ratio: 1/1; overflow: hidden; border-radius: 12px; border: 2px solid white;">
        <video id="qr-video" style="width: 100%; height: 100%; object-fit: cover;"></video>
        
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.5); pointer-events: none;"></div>
    </div>

    <p id="qr-status" style="color: #ccc; margin-top: 20px; text-align: center; max-width: 90%;"></p>

    <button id="switch-cam" style="display:none; margin-top:15px; padding:10px 20px; background:#333; color:white; border:1px solid #555; border-radius:20px;">
        Switch Camera üîÑ
    </button>
</div>

<script>
    // --- –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const apostille = document.getElementById("apostille-input").value.trim();
        const date = document.getElementById("date-input").value;
        const referral = document.getElementById("referral-input").value.trim();
        
        if(apostille && date) {
            let url = `index.html?apostille=${encodeURIComponent(apostille)}&date=${encodeURIComponent(date)}`;
            if(referral) url += `&ref=${encodeURIComponent(referral)}`;
            window.location.href = url;
        }
    });

    // === –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –°–ö–ê–ù–ï–†–ê (Nimiq QR Scanner) ===
    const scanBtn = document.getElementById("scan-qr-btn");
    const modal = document.getElementById("qr-modal");
    const closeBtn = document.getElementById("close-qr");
    const videoElem = document.getElementById("qr-video");
    const statusText = document.getElementById("qr-status");
    const switchCamBtn = document.getElementById("switch-cam");

    let scanner = null;

    // –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ Worker (—É—Å–∫–æ—Ä–∏—Ç–µ–ª—é)
    QrScanner.WORKER_PATH = 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js';

    scanBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        statusText.innerText = "–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...";
        startScanner();
    });

    closeBtn.addEventListener("click", stopScanner);

    async function startScanner() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
        if (location.protocol !== "https:" && location.hostname !== "localhost") {
            statusText.style.color = "red";
            statusText.innerText = "–û—à–∏–±–∫–∞: –ö–∞–º–µ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç HTTPS! (–ù–∞ GitHub Pages –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç)";
            return;
        }

        try {
            // –°–æ–∑–¥–∞–µ–º —Å–∫–∞–Ω–µ—Ä
            scanner = new QrScanner(videoElem, result => {
                console.log('Decoded:', result);
                handleResult(result);
            }, {
                onDecodeError: error => {
                    // –û—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                },
                highlightScanRegion: true, // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–æ–Ω—ã
                highlightCodeOutline: true, // –û–±–≤–æ–¥–∫–∞ –∫–æ–¥–∞
            });

            await scanner.start();
            statusText.innerText = "–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥";

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–∞–º–µ—Ä (–¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è)
            const cameras = await QrScanner.listCameras(true);
            if (cameras.length > 1) {
                switchCamBtn.style.display = "block";
                switchCamBtn.onclick = () => {
                    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è: –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞–º–µ—Ä—É
                    // (–¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å ID, –Ω–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω–∏—Ç –∫–æ–¥)
                    alert("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã..."); 
                };
            }

        } catch (e) {
            console.error(e);
            statusText.style.color = "red";
            statusText.innerText = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + e;
        }
    }

    function handleResult(result) {
        // result –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏
        const text = result.data || result; 
        
        statusText.style.color = "#4caf50"; // –ó–µ–ª–µ–Ω—ã–π
        statusText.innerText = "–£—Å–ø–µ—Ö! –ü–µ—Ä–µ—Ö–æ–¥...";
        stopScanner();

        if (text.includes("apostille=") && text.includes("date=")) {
            window.location.href = text;
        } else {
            alert("QR-–∫–æ–¥ —Å—á–∏—Ç–∞–Ω: " + text + "\n–ù–æ —ç—Ç–æ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç –∞–ø–æ—Å—Ç–∏–ª—è.");
        }
    }

    function stopScanner() {
        if (scanner) {
            scanner.stop();
            scanner.destroy();
            scanner = null;
        }
        modal.style.display = "none";
    }
</script>
</body>
</html>
